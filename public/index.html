<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voss Taxi - Bestillinger</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        h1 {
            font-size: 3em;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2em;
            color: #b0b0b0;
        }

        .last-update {
            margin-top: 10px;
            font-size: 0.9em;
            color: #888;
        }

        .bookings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .booking-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .booking-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }

        .booking-card.urgent {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            animation: yellowGlow 2s ease-in-out infinite;
        }

        .booking-card.under-sending {
            border-color: #ff4444;
            box-shadow: 0 0 25px rgba(255, 68, 68, 0.5);
            animation: redPulse 1.5s ease-in-out infinite;
        }

        @keyframes redPulse {
            0%, 100% {
                box-shadow: 0 0 25px rgba(255, 68, 68, 0.5);
                border-color: #ff4444;
            }
            50% {
                box-shadow: 0 0 40px rgba(255, 68, 68, 0.8);
                border-color: #ff6666;
            }
        }

        @keyframes yellowGlow {
            0%, 100% {
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            }
            50% {
                box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            }
        }

        .booking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .booking-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #ffd700;
        }

        .license-plate {
            font-size: 1.2em;
            font-weight: bold;
            color: #4CAF50;
            background: rgba(76, 175, 80, 0.2);
            padding: 5px 10px;
            border-radius: 5px;
        }

        .status {
            display: inline-block;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            margin: 10px 0;
        }

        .status.under-sending {
            background: #ff4444;
            color: white;
        }

        .status.sendt {
            background: #4CAF50;
            color: white;
        }

        .status.on-route {
            background: #2196F3;
            color: white;
        }

        .status.arrived {
            background: #FF9800;
            color: white;
        }

        .status.pob {
            background: #9C27B0;
            color: white;
        }

        .booking-details {
            margin: 15px 0;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .detail-label {
            color: #b0b0b0;
            font-weight: 500;
        }

        .detail-value {
            color: #ffffff;
            font-weight: bold;
            text-align: right;
        }

        .passengers {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .passenger-title {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 10px;
        }

        .passenger-item {
            padding: 8px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 5px;
        }

        .error-message {
            background: rgba(255, 68, 68, 0.2);
            border: 2px solid #ff4444;
            color: #ff6666;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.2em;
        }

        .loading {
            text-align: center;
            font-size: 1.5em;
            color: #ffd700;
            padding: 40px;
        }

        .no-bookings {
            text-align: center;
            font-size: 1.5em;
            color: #888;
            padding: 40px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .utrop-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ffd700;
            color: #1a1a2e;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 0.8em;
        }

        @media (max-width: 768px) {
            .bookings-grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸš– Voss Taxi</h1>
            <div class="subtitle">Bestillinger i sanntid</div>
            <div class="last-update" id="lastUpdate">Oppdaterer...</div>
        </header>

        <div id="bookingsContainer">
            <div class="loading">Laster bestillinger...</div>
        </div>
    </div>

    <audio id="chimeSound" preload="auto">
        <source src="data:audio/wav;base64,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" type="audio/wav">
    </audio>

    <script>
        const API_BASE = window.location.origin;
        let lastChimeTime = null;
        let previousUnderSendingCount = 0;

        function mapTripStatus(status) {
            const statusMap = {
                'UnderSending': 'Under sending',
                'Sent': 'KLAR FOR FASTURERING',
                'Sendt': 'KLAR FOR FASTURERING',
                'OnRoute': 'PÃ¥ vei',
                'Arrived': 'Ankommet',
                'POB': 'Passasjer ombord',
                'WaitingToPOB': 'Venter pÃ¥ passasjer'
            };

            return statusMap[status] || status;
        }

        function formatTime(dateString) {
            if (!dateString) return 'Ikke satt';

            const date = new Date(dateString);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');

            return `${hours}:${minutes}`;
        }

        function formatDate(dateString) {
            if (!dateString) return '';

            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');

            return `${day}.${month}`;
        }

        function isUrgent(pickupTime) {
            if (!pickupTime) return false;

            const pickup = new Date(pickupTime);
            const now = new Date();
            const diffMinutes = (pickup - now) / (1000 * 60);

            return diffMinutes > 0 && diffMinutes <= 5;
        }

        function playChime() {
            const audio = document.getElementById('chimeSound');
            if (audio) {
                audio.play().catch(e => console.log('Audio play failed:', e));
            }
        }

        function checkForNotifications(bookings) {
            const underSendingBookings = bookings.filter(b =>
                b.tripStatus === 'UnderSending'
            );

            // Play chime for Under Sending bookings every 30 seconds
            if (underSendingBookings.length > 0) {
                const now = Date.now();
                if (!lastChimeTime || (now - lastChimeTime) >= 30000) {
                    playChime();
                    lastChimeTime = now;
                }
            }

            // Alert if new Under Sending booking appears
            if (underSendingBookings.length > previousUnderSendingCount) {
                playChime();
                lastChimeTime = Date.now();
            }

            previousUnderSendingCount = underSendingBookings.length;
        }

        function renderBooking(booking) {
            const statusClass = booking.tripStatus.toLowerCase().replace(/\s+/g, '-');
            const urgentClass = isUrgent(booking.pickupTime) ? 'urgent' : '';
            const underSendingClass = booking.tripStatus === 'UnderSending' ? 'under-sending' : '';

            const passengers = booking.passengers || [];
            const passengersHtml = passengers.length > 0 ? `
                <div class="passengers">
                    <div class="passenger-title">Passasjerer:</div>
                    ${passengers.map(p => `
                        <div class="passenger-item">
                            ${p.name || 'Ikke navngitt'} ${p.phoneNo ? `- ${p.phoneNo}` : ''}
                        </div>
                    `).join('')}
                </div>
            ` : '';

            return `
                <div class="booking-card ${urgentClass} ${underSendingClass}">
                    ${booking.pickupTime && isUrgent(booking.pickupTime) ?
                        '<div class="utrop-indicator">UTROP</div>' : ''}

                    <div class="booking-header">
                        <div class="booking-number">#${booking.internalNo || 'N/A'}</div>
                        <div class="license-plate">${booking.licenseNo || 'Ikke tildelt'}</div>
                    </div>

                    <div class="status ${statusClass}">
                        ${mapTripStatus(booking.tripStatus)}
                    </div>

                    <div class="booking-details">
                        <div class="detail-row">
                            <span class="detail-label">Fra:</span>
                            <span class="detail-value">${booking.pickupAddress || 'Ikke satt'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Til:</span>
                            <span class="detail-value">${booking.dropoffAddress || 'Ikke satt'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Henting:</span>
                            <span class="detail-value">
                                ${formatDate(booking.pickupTime)}
                                ${formatTime(booking.pickupTime)}
                            </span>
                        </div>
                        ${booking.comment ? `
                            <div class="detail-row">
                                <span class="detail-label">Kommentar:</span>
                                <span class="detail-value">${booking.comment}</span>
                            </div>
                        ` : ''}
                    </div>

                    ${passengersHtml}
                </div>
            `;
        }

        async function fetchBookings() {
            const container = document.getElementById('bookingsContainer');

            try {
                const response = await fetch(`${API_BASE}/api/trips`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const bookings = data.items || [];

                // Update last update time
                const now = new Date();
                document.getElementById('lastUpdate').textContent =
                    `Sist oppdatert: ${formatTime(now.toISOString())}`;

                // Check for notifications
                checkForNotifications(bookings);

                // Sort bookings: UnderSending first, then by pickup time
                bookings.sort((a, b) => {
                    if (a.tripStatus === 'UnderSending' && b.tripStatus !== 'UnderSending') return -1;
                    if (a.tripStatus !== 'UnderSending' && b.tripStatus === 'UnderSending') return 1;

                    if (a.pickupTime && b.pickupTime) {
                        return new Date(a.pickupTime) - new Date(b.pickupTime);
                    }
                    return 0;
                });

                if (bookings.length === 0) {
                    container.innerHTML = `
                        <div class="no-bookings">
                            Ingen aktive bestillinger
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="bookings-grid">
                            ${bookings.map(renderBooking).join('')}
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Error fetching bookings:', error);
                container.innerHTML = `
                    <div class="error-message">
                        Kunne ikke laste bestillinger<br>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }

        // Initial fetch
        fetchBookings();

        // Fetch every 30 seconds
        const interval = setInterval(fetchBookings, 30000);

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            clearInterval(interval);
        });
    </script>
</body>
</html>
